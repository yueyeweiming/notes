# 深入理解Java虚拟机-类文件结构

## 6.3 Class类文件的结构
Class文件是一组以8个字节为基础单位的二进制流,各个数据项目严格按照顺序紧凑的排列在class文件之中,中间没有添加任何分隔符.当遇到需要占用8位字节以上空间的数据项时,则会按照高位在前的方式分割成若干个8位字节进行存储.

Class文件只有两种数据类型:

* 无符号数:基本数据类型,使用u1,u2,u4,u8来分别代表一个字节,2个字节,4个字节和8个字节的无符号数.无符号数可以用来描述数字,索引引用,数量值或者按照UTF-8编码构成的字符串量.
* 表是由多个无符号数或其他表作为数据项构成的复合数据结构,所有表都习惯性的以_info结尾.标用于描述有层次关系的复合结构的数据,整个Class文件本质上就是一张表.

### 6.3.1 魔法数与Class 文件的版本
每个Class文件的头4个字节称为魔法数(magic number).作用是确定这个文件是否为一个能被虚拟机接受的Class文件.很多文件存储标准都使用魔法数来进行身份识别.值为0XCAFEBABE(咖啡宝贝?-_-).
紧接着魔法数的四个字节存储的是Class文件的版本号,第5,第6个字节是次版本号,第7第八个字节是主版本号.Java的版本号是从45开始.虚拟机必须拒绝超过其版本号的Class文件(向前兼容不向后兼容)

### 6.3.2 常量池
主次版本号之后就是常量池入口,常量池可以理解为Class文件之中的仓库资源,它是Class文件结构中与其他项目关联最多的数据类型.

由于常量池中的常量的数量是不固定的,所以在常量池的入口需要放置一项u2类型的数据,代表常量池容量计数值.0位空出,表示不引用任何.

常量池中主要存放两大类常量:

*  字面量:java语言层面的常量
* 符号引用:编译原理方面的概念
	* 类和接口的全限定名
	* 字段的名称和描述符
	* 方法的名称和描述符

常量池中每一项常量都是一个表,JDK1.7之前共有11种结构各不相同的表结构数据,JDK1.7又增加了3种.

这14种表示开始的第一位是一个u1类型的标志位,代表当前这个常量属于哪种类型常量.

### 6.3.3 访问标志
常量池结束之后,紧接着的两个字节代表访问标志(access_flags),这个标志用于识别一些类或者接口层次的访问信息

* 这个Class是类还是接口或注解或枚举
* 是否定义为public类型
* 是否定义为abstract类型
* 是否final

### 6.3.4 类索引,父类索引与接口索引集合
类索引和父类索引都是一个u2类型的数据,而接口索引集合是一族u2类型的数据的集合.Class文件中由这三项数据来确定类的继承关系.

* 类索引用于确定这个类的全限定名.
* 父类索引用于确定这个类的父类的全限定名
* 接口索引集合描述这个类实现了哪些接口

### 6.3.5 字段表集合
字段表(field_info)用于描述接口或者类中声明的变量.字段包括类级变量以及实例级变量,但不包括在方法内部声明的局部变量.
access_flags => name_index=>descriptor_index

1. access_flags:很好理解
2. name_index:字段的简单名称(引用常量池)
3. descriptor_index字段的数据类型(引用常量池)()


#### 全限定名称和简单名称

1. 全限定名称:例如pr/magic/TestClass;,使用;表示全限定名结束
2. 简单名称:指没有类型和参数修饰的方法或者字段名称.

#### 描述符
描述符的作用是用来描述字段的数据类型,方法的参数列表(包括数量,类型以及顺序)
和返回值.

根据描述符规则,基本数据类型和无返回值的void类型都用一个大写字符来表示,而对象类型则用L加对象的全限定名称来表示.对于数据类型,每一个纬度使用一个前置的[字符来描述.例如int[][]被记录为[[I.

用描述符来描述方法时,按照先参数列表,后返回值的顺序描述,参数列表按照参数的严格顺序放在一组小括号()之内,如方法void inc()的描述符为()V.

### 6.3.6 方法表集合
Class文件中对方法的描述与对字段的描述几乎采用了完全一致的方式,依次包含了访问标志,名称索引,描述符索引,属性表集合几项.方法里 的Java代码,经过编译器编译成字节码指令后,存放在方法属性集合中一个名为Code的属性里面.

在Java语言中,要重载一个方法,除了要与原方法具有相同的简单名称之外,还要求必须拥有一个与原方法不同的特征签名,特征签名就是一个方法中各个参数在常量池中的字段符号引用的集合.

### 6.3.7 属性表集合
在Class文件,字段表,方法表中都可以携带自己的属性表集合,以用于描述某些场景专有的信息.

属性表不具有严格的顺序,并且只要不与已有属性名重复,任何人实现的编译器都可以向属性表中写入自己定义的属性信息,Java虚拟机运行时会忽略掉它不认识的属性.

#### 1. Code属性
1. max_stack代表了操作数栈的最大深度
2. max_locals 代表了局部变量表所需的存储空间
3. code_length和code用来存储Java源程序编译后生成的字节码指令.code_length代表字节码长度,code用于存储字节码指令的一系列字节流.虚拟机不允许一个方法超过65535条字节码指令.

#### 2. Exceptions属性
这个Exceptions是指方法中可能抛出的异常.也就是throws关键字后面列举的异常.
#### 3. LineNumberTable
用于描述Java源码行号和字节码行号之间的对应关系,它会影响抛出异常时的堆栈信息显示行号.以及debug的时候设置断点.
#### 4. LocalVariableTable属性
用于描述栈桢中局部变量表中的变量与Java源码中定义的变量之间的关系,
#### 5. SourceFile属性
用于记录生成这个Class文件的源码文件名称.
#### ConstantValue
通知虚拟机自动为静态变量赋值.只有被static关键字修饰的变量才可以使用这项属性.此属性的属性值只是一个常量池的索引号.由于Class文件格式中的常量类型中只有基本类型和字符串类型相对应的字面凉,所以Constant-Value只能支持这些类型.

* 类构造器<init>方法
* 实例构造器<clinit>方法

#### InnerClasses属性
用于记录内部类与宿主类之间的关联,如果一个类中定义了内部类,那编译器将会为它以及它所包含的内部类生成InnerClasses属性.

#### StackmapTable属性
这个属性会在虚拟机类加载的字节码验证阶段被新类型检查验证器使用,目的在于替代以前比较小寒性能的基于数据流分析的类型推导验证器.

#### Signature属性
可选的定长属性,可以出现于类,属性表和方法表结构的属性表中.泛型签名如果包含了类型变量或参数化类型,则Signature属性会为它记录泛型签名信息.Signature是为了支持运行时能够获得泛型类型.

## 6.4 字节码指令简介
Java虚拟机的指令由一个字节长度的,代表着某种特定操作含义的数组以及跟随其后的0到多个
代表此操作所需参数而构成.

### 6.4.1 字节码与数据类型











